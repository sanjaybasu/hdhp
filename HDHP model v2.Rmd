---
title: "HDHP model v2"
author: "Sanjay Basu"
date: "8/27/2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE, cache.lazy = FALSE)
library(foreign)
library(survey)
library(tidyverse)
library(plyr)
library(ggplot2)
library(scales)
library(nhanesA)
library(stringr)

```

## KFF 2018 EHBS

```{r import}
setwd("~/Box/Analytics Team/Data Sources & Examples/KFF Health Benefits Survey/health benefits 2018")
df = read.spss('Health Benefits 2018.sav', to.data.frame = T)

```

## descriptive stats

```{r desc}
options( survey.lonely.psu = "adjust" )
covwt.design <- svydesign(
      ~1 ,
      strata = ~newcell ,
      weight = ~empwt ,
      data = subset( df , covwt > 0 )
      )
svytable(~b8e+ppo, covwt.design)  # Firm Offers a HDHP (with or without SO) -and Does Firm Have PPO


mu1=svymean(~b12c, covwt.design,na.rm=T)[1] #Percent of Workers with Health Benefits Covered in PPO Plan 
mu2=svymean(~b12e, covwt.design,na.rm=T)[1] #Percent of Workers with Health Benefits Covered in HDHP
dftemp = data.frame(enroll= c(df$b12c,df$b12e),
                    type = c(rep("PPO",length(df$b12c)), rep("HDHP",length(df$b12e))),
                    empwt = df$empwt)
mu = data.frame(grp.mean = c(mu1,mu2),
                type = c("PPO","HDHP"))
p<-ggplot(dftemp, aes(x=enroll, color=type, weight = empwt)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=type),
             linetype="dashed")
p + scale_color_brewer(palette="Set1") + 
  theme_minimal()+theme(legend.position="top") +  scale_y_continuous(labels = scales::comma)+
  labs(title="Proportion of workers subscribing to HDHP or PPO plan",x="Proportion of workers enrolled in each firm", y = "Number of firms")


mu1=svymean(~ddctsppo, covwt.design,na.rm=T)[1] #Average Deductible Among Covered Workers Who Face a Deductible for Single Coverage - PPO
mu2=svymean(~ddctshdp, covwt.design,na.rm=T)[1] #Average Deductible Among Covered Workers Who Face a Deductible for Single Coverage - HDP
dftemp = data.frame(enroll= c(df$ddctsppo,df$ddctshdp),
                    type = c(rep("PPO",length(df$ddctsppo)), rep("HDHP",length(df$ddctshdp))),
                    empwt = df$empwt)
mu = data.frame(grp.mean = c(mu1,mu2),
                type = c("PPO","HDHP"))
p<-ggplot(dftemp, aes(x=enroll, color=type, weight = empwt)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=type),
             linetype="dashed")
p + scale_color_brewer(palette="Set1") + 
  theme_minimal()+theme(legend.position="top") +  scale_y_continuous(labels = scales::comma)+
  labs(title="Deductibles for Single Coverage",x="$US", y = "Number of firms")


mu1=svymean(~prmsppoa, covwt.design,na.rm=T)[1] #Annual Premiums for Single coverage - PPO
mu2=svymean(~prmshdpa, covwt.design,na.rm=T)[1] #Annual Premiums for Single coverage - HDP
dftemp = data.frame(enroll= c(df$prmsppoa,df$prmshdpa),
                    type = c(rep("PPO",length(df$prmsppoa)), rep("HDHP",length(df$prmshdpa))),
                    empwt = df$empwt)
mu = data.frame(grp.mean = c(mu1,mu2),
                type = c("PPO","HDHP"))
p<-ggplot(dftemp, aes(x=enroll, color=type, weight = empwt)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=type),
             linetype="dashed")
p + scale_color_brewer(palette="Set1") + 
  theme_minimal()+theme(legend.position="top") +  scale_y_continuous(labels = scales::comma)+
  labs(title="Premiums for Single Coverage",x="$US", y = "Number of firms")


mu1=svymean(~e6b, covwt.design,na.rm=T)[1] #Coinsurance Rate for an Office Visit - PPO
mu2=svymean(~g6b, covwt.design,na.rm=T)[1] #Coinsurance Rate for an Office Visit - HDP
dftemp = data.frame(enroll= c(df$e6b,df$g6b),
                    type = c(rep("PPO",length(df$e6b)), rep("HDHP",length(df$g6b))),
                    empwt = df$empwt)
mu = data.frame(grp.mean = c(mu1,mu2),
                type = c("PPO","HDHP"))
p<-ggplot(dftemp, aes(x=enroll, color=type, weight = empwt)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=type),
             linetype="dashed")
p + scale_color_brewer(palette="Set1") + 
  theme_minimal()+theme(legend.position="top") +  scale_y_continuous(labels = scales::comma)+
  labs(title="Coinsurance Rate for an Office Visit",x="%", y = "Number of firms")



mu1=svymean(~g43ann, covwt.design,na.rm=T)[1] #Annual HSA Firm Contribution: Single -
#mu2=svymean(~g6b, covwt.design,na.rm=T)[1] #Coinsurance Rate for an Office Visit - HDP
dftemp = data.frame(enroll= c(df$g43ann),
                    type = c(rep("HDHP",length(df$g43ann))),
                    empwt = df$empwt)
mu = data.frame(grp.mean = c(mu1),#,mu2),
                type = c("HDHP"))
p<-ggplot(dftemp, aes(x=enroll, color=type, weight = empwt)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=type),
             linetype="dashed")
p + scale_color_brewer(palette="Set1") + 
  theme_minimal()+theme(legend.position="top") +  scale_y_continuous(labels = scales::comma)+
  labs(title="HSA Firm Contribution",x="$US", y = "Number of firms")


```


## calcs

calculate per firm cost among those offerring HDHP: subscriber # per 1000 employees in HDHP, paid claim $ per person, payroll contribution $ per person, HSA seed per person, employer cost per person => get employer cost per 1000 = scribers/1000 * (paid claims - payroll + hsa seed)


```{r sub}
svymean(~prmshdpa, covwt.design,na.rm=T)[1]
svymean(~epctshdp, covwt.design,na.rm=T)[1]
svymean(~g43ann, covwt.design,na.rm=T)[1]
svymean(~wkrshdpa, covwt.design,na.rm=T)[1]

0.85* svymean(~prmshdpa, covwt.design,na.rm=T)[1] * svymean(~epctshdp, covwt.design,na.rm=T)[1] + svymean(~g43ann, covwt.design,na.rm=T)[1] - svymean(~wkrshdpa, covwt.design,na.rm=T)[1]

0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.025))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.025))[1] + svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.025))[1] - svyquantile(~wkrshdpa, covwt.design,na.rm=T, quantiles = c(.025))[1]

0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.975))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.975))[1] + svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.975))[1] - svyquantile(~wkrshdpa, covwt.design,na.rm=T, quantiles = c(.975))[1]


df_sub = df %>%
  filter(hdhp_yn=="Yes") %>% # find subset of firms with HDHPs + HSA
  mutate(g43ann  = replace_na(g43ann,mean(na.omit(g43ann))),
         g6b = replace_na(g6b,mean(na.omit(g6b))),
         n_hdhp_per_1000 = b12e*100*10, # subscriber # per 1000 employees in HDHP
         pmpy_clms = 0.85 * prmshdpa * epctshdp ,  # loss ratio * premium as estimate of typical claims costs * employer % of premium cost
         pmpy_payroll_contr = wkrshdpa, # $ worker contribution
         pmpy_hsa_seed = g43ann, # firm HSA seed
         deductible = ddctshdp, # Average Deductible Among Covered Workers Who Face a Deductible for Single Coverage - HDP
         coins = g6b, # Coinsurance rate for an office visit
         firm_cost_per_1000 = n_hdhp_per_1000*(pmpy_clms - pmpy_payroll_contr + pmpy_hsa_seed))   # cost to firm for HDHP per 1000 employees
  
```

# transition HDHP pop to PPO
calculate from Lo Sasso table 4 column 2 [OLS] how much change in total spending would occur without HSA and with lower deductible including in-network coinsurance, and hosp/surgery deductible (significant variables at 5% alpha)
DOI: 10.1111/j.1539-6975.2009.01346.x


```{r hdhp to ppo}

0.85* svymean(~prmshdpa, covwt.design,na.rm=T)[1] * svymean(~epctshdp, covwt.design,na.rm=T)[1] + -(-1.23 * svymean(~g43ann, covwt.design,na.rm=T)[1]+0.55 * (svymean(~ddctsppo, covwt.design,na.rm=T)[1]-svymean(~ddctshdp, covwt.design,na.rm=T)[1])+82.13*(svymean(~e6b, covwt.design,na.rm=T)[1]-svymean(~g6b, covwt.design,na.rm=T)[1])/100) 

0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.025))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.025))[1]  + -(-1.23 * svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.025))[1]+0.55 * (svyquantile(~ddctsppo, covwt.design,na.rm=T, quantiles = c(.025))[1]-svyquantile(~ddctshdp, covwt.design,na.rm=T, quantiles = c(.025))[1])+82.13*(svyquantile(~e6b, covwt.design,na.rm=T, quantiles = c(.025))[1]-svyquantile(~g6b, covwt.design,na.rm=T, quantiles = c(.025))[1])/100)

0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.975))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.975))[1] + -(-1.23 * svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.975))[1]+0.55 * (svyquantile(~ddctsppo, covwt.design,na.rm=T, quantiles = c(.975))[1]-svyquantile(~ddctshdp, covwt.design,na.rm=T, quantiles = c(.975))[1])+82.13*(svyquantile(~e6b, covwt.design,na.rm=T, quantiles = c(.975))[1]-svyquantile(~g6b, covwt.design,na.rm=T, quantiles = c(.975))[1])/100)

svymean(~wkrsppoa, covwt.design,na.rm=T)[1]
svyquantile(~wkrsppoa, covwt.design,na.rm=T, quantiles = c(.025))[1]
svyquantile(~wkrsppoa, covwt.design,na.rm=T, quantiles = c(.975))[1]


0.85* svymean(~prmshdpa, covwt.design,na.rm=T)[1] * svymean(~epctshdp, covwt.design,na.rm=T)[1] + -(-1.23 * svymean(~g43ann, covwt.design,na.rm=T)[1]+0.55 * (svymean(~ddctsppo, covwt.design,na.rm=T)[1]-svymean(~ddctshdp, covwt.design,na.rm=T)[1])+82.13*(svymean(~e6b, covwt.design,na.rm=T)[1]-svymean(~g6b, covwt.design,na.rm=T)[1])/100)  - svymean(~wkrsppoa, covwt.design,na.rm=T)[1]

0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.025))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.025))[1]  + -(-1.23 * svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.025))[1]+0.55 * (svyquantile(~ddctsppo, covwt.design,na.rm=T, quantiles = c(.025))[1]-svyquantile(~ddctshdp, covwt.design,na.rm=T, quantiles = c(.025))[1])+82.13*(svyquantile(~e6b, covwt.design,na.rm=T, quantiles = c(.025))[1]-svyquantile(~g6b, covwt.design,na.rm=T, quantiles = c(.025))[1])/100) - svyquantile(~wkrsppoa, covwt.design,na.rm=T, quantiles = c(.025))[1]


0.85* svyquantile(~prmshdpa, covwt.design,na.rm=T, quantiles = c(.975))[1] * svyquantile(~epctshdp, covwt.design,na.rm=T, quantiles = c(.975))[1] + -(-1.23 * svyquantile(~g43ann, covwt.design,na.rm=T, quantiles = c(.975))[1]+0.55 * (svyquantile(~ddctsppo, covwt.design,na.rm=T, quantiles = c(.975))[1]-svyquantile(~ddctshdp, covwt.design,na.rm=T, quantiles = c(.975))[1])+82.13*(svyquantile(~e6b, covwt.design,na.rm=T, quantiles = c(.975))[1]-svyquantile(~g6b, covwt.design,na.rm=T, quantiles = c(.975))[1])/100) - svyquantile(~wkrsppoa, covwt.design,na.rm=T, quantiles = c(.975))[1]


  
df_sub = df_sub %>%
  mutate(ddctsppo = replace_na(ddctsppo,mean(na.omit(ddctsppo))),
         deductible_post = ddctsppo,
         e6b = replace_na(e6b,mean(na.omit(e6b))),
         coins_post = e6b, 
           pmpy_clms_post = pmpy_clms + (-1.23 * pmpy_hsa_seed+
                                       0.55 * (deductible-deductible_post)+
                                         82.13*(coins-coins_post)/100),
         wkrsppoa = replace_na(wkrsppoa,mean(na.omit(wkrsppoa))),
         pmpy_payroll_contr_post = wkrsppoa,
         firm_cost_per_1000_post = n_hdhp_per_1000*(pmpy_clms_post - pmpy_payroll_contr_post)) %>%
    select(n_hdhp_per_1000, pmpy_clms, pmpy_clms_post, pmpy_payroll_contr, pmpy_payroll_contr_post, pmpy_hsa_seed, deductible, coins, deductible_post, coins_post, firm_cost_per_1000, firm_cost_per_1000_post)

```

# validation
validate selection against Einav Figure 4 given relevant % choosing HDHP

```{r validation}

x_model = df_sub$n_hdhp_per_1000/1000
y_model = (df_sub$pmpy_clms-df_sub$pmpy_clms_post)

x_einav = seq(0,100,5)/100
y_einav = c(0,60,131,175,215,240,260,270,280,290,285,300,310,320,330,340,345,346,350,350,348)

plot(x_model, y_model, col = "dodgerblue", pch = 1, xlab="Proportion of employees on HDHP", ylab="Claim savings from HDHP ($/indiv/yr)")
points(x_einav, y_einav, col = "red", pch = 15)
title("Comparison to Einav et al., AER (2013) simulation")
legend("topleft",     c("Current estimates","Einav simulation"), pch=c(1,15), col=c("dodgerblue","red"), inset = .05)


```

# health impact
then calculate impact of reduced adherence to DM, statins, and HTN drugs based on 5% improvement in adherence [ https://doi.org/10.1161/CIRCOUTCOMES.118.004632 ]
given baseline rates of: 68.6% for diabetes medicines, 71.8% for statins, and 71.6% for blood pressure drugs [ https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2842539/ , table 4 column 5 ]

and given meta-analytic estimates of delta A1c => RECODE estimates of change in complications and associated $ over time until retirement, and calculation of decr MI/stroke risk and Dollars associated w statin or HTN drugs given AHA/ACC ASCVD Risk estimator + online and NHANES employed population as simualted cohort, subset to the NHANES subpop that has the prevalence of HDHP enrollees per NHIS


```{r nhanes nhis}

# NHANES 2015-2016


demo <- nhanes('DEMO_I')
bmx <- nhanes('BMX_I')
tchol <- nhanes('TCHOL_I')
hdl <- nhanes('HDL_I')
bpq <- nhanes('BPQ_I')
ghb <- nhanes('GHB_I')
diq <- nhanes('DIQ_I')
biopro <- nhanes('BIOPRO_I')
albcr <- nhanes('ALB_CR_I')
bpx <- nhanes('BPX_I')
diet <- nhanes('DR1IFF_I')
rxq <- nhanes('RXQ_RX_I')
smq <- nhanes('SMQ_I')
mcq <- nhanes('MCQ_I')
occ <- nhanes('OCQ_I')
glu <- nhanes('GLU_I')
hic <- nhanes('HIQ_I')

demo <- nhanesTranslate('DEMO_I', 
                         colnames = c('RIAGENDR','RIDRETH1'), 
                         data=demo)



merged = merge(demo, bmx)
merged = merge(merged, tchol)
merged = merge(merged, hdl)
merged = merge(merged, bpq)
merged = merge(merged, ghb)
merged = merge(merged, diq)
merged = merge(merged, biopro)
merged = merge(merged, albcr)
merged = merge(merged, bpx)
merged = merge(merged, diet) 
merged = merge(merged, rxq)
merged = merge(merged, smq)
merged = merge(merged, mcq)
merged = merge(merged, occ)
merged = merge(merged, glu)
merged = merge(merged, hic)
mergedsub = merged %>%
  filter(HIQ031A==14) # privately-insured subset


age = mergedsub$RIDAGEYR
female = (mergedsub$RIAGENDR=="Female")
black = (mergedsub$RIDRETH1=="Non-Hispanic Black")
black[is.na(black)]=0
hisp = (mergedsub$RIDRETH1=="Other Hispanic")
hisp[is.na(hisp)]=0
bmi = mergedsub$BMXBMI
bmi[is.na(bmi)]=mean(na.omit(bmi))
totchol = mergedsub$LBXTC
totchol[is.na(totchol)]=mean(na.omit(totchol))
hdlc = mergedsub$LBDHDD
hdlc[is.na(hdlc)]=mean(na.omit(hdlc))
dm = (mergedsub$DIQ010==1) | 
  (mergedsub$LBXGH>=6.5) | 
  (mergedsub$LBXGLU>=126)
dm[is.na(dm)]=0
sercreat = mergedsub$LBXSCR
sercreat[is.na(sercreat)]=mean(na.omit(sercreat))
uralbcreat =  mergedsub$URDACT
uralbcreat[is.na(uralbcreat)]=mean(na.omit(uralbcreat))
sysbp = mergedsub$BPXSY1
sysbp[is.na(sysbp)]=mean(na.omit(sysbp))
rxbp = (mergedsub$BPQ040A==1)
rxbp[is.na(rxbp)]=0
cvdhist = (mergedsub$MCQ160F==1)|(mergedsub$MCQ160F==1)
cvdhist[is.na(cvdhist)]=0
hgba1c = mergedsub$LBXGH
hgba1c[is.na(hgba1c)]=mean(na.omit(hgba1c))
cursmoke = (mergedsub$SMQ040==1 | mergedsub$SMQ040==2)
cursmoke[is.na(cursmoke)]=0

statin = grepl("STATIN",mergedsub$RXDDRUG)
statin[is.na(statin)]=0
oralrx = grepl("METFORMIN",mergedsub$RXDDRUG)|grepl("GLIPIZIDE",mergedsub$RXDDRUG)
oralrx[is.na(oralrx)]=0
anticoag = grepl("WARFARIN",mergedsub$RXDDRUG)
anticoag[is.na(anticoag)]=0



```


# Calculate baseline risk scores, 10 year => project to pre-retirement

1. Yadlowsky S, Hayward RA, Sussman JB, McClelland RL, Min Y, Basu S. Clinical Implications of Revised Pooled Cohort Equations for Estimating Atherosclerotic Cardiovascular Disease Risk. Ann Intern Med. ;169:20â€“29. doi: 10.7326/M17-3011

2. Basu S, Sussman JB, Berkowitz SA, Hayward RA, Yudkin JS. Development and validation of Risk Equations for Complications Of type 2 Diabetes (RECODe) using individual participant data from randomised trials. Lancet Diabetes Endocrinol. 2017;5(10):788-798.

3. Sanjay Basu, Jeremy B. Sussman, Seth A. Berkowitz, Rodney A. Hayward, Alain G. Bertoni, Adolfo Correa, Stanford Mwasongwe, John S. Yudkin. Validation of Risk Equations for Complications of Type 2 Diabetes (RECODe) Using Individual Participant Data From Diverse Longitudinal Cohorts in the U.S. Diabetes Care Mar 2018, 41 (3) 586-595; DOI: 10.2337/dc17-2002




```{r baseline risk scores, 10 year}

# ASCVD
ascvd_10   = ( 1.0*female / (1.0 + exp( - (
  -12.823110 +
    0.106501 * as.numeric(age) +
    0.432440 * as.numeric(black) +
    0.000056 * (as.numeric(sysbp) ^ 2) +
    0.017666 * as.numeric(sysbp) +
    0.731678 * as.numeric(rxbp) +
    0.943970 * as.numeric(dm) +
    1.009790 * as.numeric(cursmoke) +
    0.151318 * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.008580 * as.numeric(age) * as.numeric(black) +
    -0.003647 * as.numeric(sysbp) * as.numeric(rxbp) +
    0.006208 * as.numeric(sysbp) * as.numeric(black) +
    0.152968 * as.numeric(black) * as.numeric(rxbp) +
    -0.000153 * as.numeric(age) * as.numeric(sysbp) +
    0.115232 * as.numeric(black) * as.numeric(dm) +
    -0.092231 * as.numeric(black) * as.numeric(cursmoke) +
    0.070498 * as.numeric(black) * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.000173 * as.numeric(black)  * as.numeric(sysbp) * as.numeric(rxbp) +
    -0.000094 * as.numeric(age) * as.numeric(sysbp) * as.numeric(black)))))+
  (1.0*(1-female) / (1.0 + exp( - (
  -11.679980 +
    0.064200 * as.numeric(age) +
    0.482835 * as.numeric(black) +
    -0.000061 * (as.numeric(sysbp) ^ 2) +
    0.038950 * as.numeric(sysbp) +
    2.055533 * as.numeric(rxbp) +
    0.842209 * as.numeric(dm) +
    0.895589 * as.numeric(cursmoke) +
    0.193307 * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.014207 * as.numeric(sysbp) * as.numeric(rxbp) +
    0.011609 * as.numeric(sysbp) * as.numeric(black) +
    -0.119460 * as.numeric(rxbp) * as.numeric(black) +
    0.000025 * as.numeric(age) * as.numeric(sysbp) +
    -0.077214 * as.numeric(black) * as.numeric(dm) +
    -0.226771 * as.numeric(black) * as.numeric(cursmoke) +
    -0.117749 * (as.numeric(totchol) / as.numeric(hdlc)) * as.numeric(black) +
    0.004190 * as.numeric(black) * as.numeric(rxbp) * as.numeric(sysbp) +
    -0.000199 * as.numeric(black) * as.numeric(age) * as.numeric(sysbp)))))

      
# DM incidence
# https://www.cdc.gov/diabetes/data/statistics-report/incidence-diabetes.html
dminc_10 = (mean(c(.031,.068))*(age<45)+
  mean(c(.109,.068))*(age>=45 & age<65)+
  mean(c(.094,.068))*(age>=65))*100/1000*10


# DM neph
nbetax = (-1.938e-02*age+
           -1.129e-02*female+
           -8.812e-02*black+
           2.338e-01*hisp+
           1.483e-01*cursmoke+
           3.027e-03*sysbp+
           -7.952e-02*rxbp+
           -1.256e-01*oralrx+
           3.199e-02*anticoag+
           -2.164e-02*cvdhist+
           1.369e-01*hgba1c+
           -1.112e-03*totchol+
           6.289e-03*hdlc+
           8.609e-01*sercreat+
           3.615e-04*uralbcreat)
esrdrisk_10 = 1-.973^exp(nbetax-mean(nbetax,na.rm=T))

# DM retin

rbetax = (2.285e-02*age+
           2.264e-01*female+
           -1.677e-01*black+
           8.243e-03*sysbp+
           6.393e-02*rxbp+
           -2.349e-01*oralrx+
           1.127e-01*cvdhist+
           1.449e-01*hgba1c+
           -1.676e-04*totchol+
           5.447e-03*hdlc+
           6.947e-01*sercreat+
           1.992e-04*uralbcreat)
retinrisk_10 = 1 - .92^exp(rbetax-mean(rbetax,na.rm=T))


# DM neuro
ebetax = (0.0302237*age+
           -0.1868000*female+
            -0.0944841*black+
           0.0045609*sysbp+
           0.1819157*rxbp+
           -0.2574724*oralrx+
           0.2667152*cvdhist+
           0.1886579*hgba1c+
           0.0021850*totchol+
           -0.0053887*hdlc+
           0.6044183*sercreat)
neurorisk_10 = 1 - .87^exp(ebetax-mean(ebetax,na.rm=T))



# All cause mort
abetax = (6.703e-02*age+
           -1.529e-01*female+
            -2.393e-02*black+
           5.399e-01*cursmoke+
           -2.988e-03*sysbp+
           8.776e-02*rxbp+
           -2.681e-01*statin+
           4.036e-01*anticoag+
           -0.2574724*oralrx+
           5.888e-01*cvdhist+
           1.659e-01*hgba1c+
           -9.478e-04*totchol+
           -4.378e-03*hdlc+
           3.597e-01*sercreat+
           3.889e-04*uralbcreat)
mortrisk_10 = 1 - .93^exp(abetax-mean(abetax,na.rm=T))
```

```{r baseline risk scores, through pre-retirement}
# https://www.cdc.gov/nchs/data/nvsr/nvsr66/nvsr66_04.pdf
lifeexp = (female==0)*(black==0)*(hisp==0)*( # NH WM (non-Hispanic White Male)
62.1*(age<20)+
57.3*(age>=20 & age<25)+
52.6*(age>=25 & age<30)+
47.9*(age>=30 & age<35)+
43.3*(age>=35 & age<40)+
38.7*(age>=40 & age<45)+
34.2*(age>=45 & age<50)+
29.8*(age>=50 & age<55)+
25.7*(age>=55 & age<60)+
21.7*(age>=60 & age<65)+
18*(age>=65 & age<70)+
14.4*(age>=70 & age<75)+
11.2*(age>=75 & age<80)+
8.3*(age>=80)
)+
  (female==1)*(black==0)*(hisp==0)*( # NH WF
66.7*(age<20)+
61.8*(age>=20 & age<25)+
56.9*(age>=25 & age<30)+
52.1*(age>=30 & age<35)+
47.3*(age>=35 & age<40)+
42.5*(age>=40 & age<45)+
37.9*(age>=45 & age<50)+
33.3*(age>=50 & age<55)+
28.9*(age>=55 & age<60)+
24.7*(age>=60 & age<65)+
20.5*(age>=65 & age<70)+
16.6*(age>=70 & age<75)+
13*(age>=75 & age<80)+
9.7*(age>=80)
  )+
  (female==0)*(black==1)*(hisp==0)*( # NH BM
58.3*(age<20)+
53.6*(age>=20 & age<25)+
49*(age>=25 & age<30)+
44.5*(age>=30 & age<35)+
40*(age>=35 & age<40)+
35.6*(age>=40 & age<45)+
31.2*(age>=45 & age<50)+
27*(age>=50 & age<55)+
23*(age>=55 & age<60)+
19.4*(age>=60 & age<65)+
16.3*(age>=65 & age<70)+
13.2*(age>=70 & age<75)+
10.5*(age>=75 & age<80)+
8.1*(age>=80)  
)+
  (female==1)*(black==1)*(hisp==0)*( # NH BF
64.2*(age<20)+
59.3*(age>=20 & age<25)+
54.5*(age>=25 & age<30)+
49.7*(age>=30 & age<35)+
44.9*(age>=35 & age<40)+
40.3*(age>=40 & age<45)+
35.7*(age>=45 & age<50)+
31.3*(age>=50 & age<55)+
27.2*(age>=55 & age<60)+
23.3*(age>=60 & age<65)+
19.5*(age>=65 & age<70)+
16*(age>=70 & age<75)+
12.7*(age>=75 & age<80)+
9.8*(age>=80)      
  )+
  (female==0)*(black==0)*(hisp==1)*( # HM
65*(age<20)+
60.1*(age>=20 & age<25)+
55.4*(age>=25 & age<30)+
50.7*(age>=30 & age<35)+
45.9*(age>=35 & age<40)+
41.2*(age>=40 & age<45)+
36.6*(age>=45 & age<50)+
32.1*(age>=50 & age<55)+
27.7*(age>=55 & age<60)+
23.6*(age>=60 & age<65)+
19.7*(age>=65 & age<70)+
16*(age>=70 & age<75)+
12.6*(age>=75 & age<80)+
9.5*(age>=80)    
)+
  (female==1)*(black==0)*(hisp==1)*( # HF
70*(age<20)+
65*(age>=20 & age<25)+
60.2*(age>=25 & age<30)+
55.3*(age>=30 & age<35)+
50.4*(age>=35 & age<40)+
45.5*(age>=40 & age<45)+
40.7*(age>=45 & age<50)+
36.1*(age>=50 & age<55)+
31.5*(age>=55 & age<60)+
27*(age>=60 & age<65)+
22.8*(age>=65 & age<70)+
18.7*(age>=70 & age<75)+
14.8*(age>=75 & age<80)+
11.2*(age>=80)       
  )

lifeexp = lifeexp-(78.69-65)

ascvd_rate = -log(1-ascvd_10)/10
ascvd_life = 1-exp(-ascvd_rate*lifeexp)

dminc_rate = -log(1-dminc_10)/10
dminc_life = 1-exp(-dminc_rate*lifeexp)

esrdrisk_rate = -log(1-esrdrisk_10)/10
esrdrisk_life = 1-exp(-esrdrisk_rate*lifeexp)

retinrisk_rate = -log(1-retinrisk_10)/10
retinrisk_life = 1-exp(-retinrisk_rate*lifeexp)

neurorisk_rate = -log(1-neurorisk_10)/10
neurorisk_life = 1-exp(-neurorisk_rate*lifeexp)

mortrisk_rate = -log(1-mortrisk_10)/10
mortrisk_life = 1-exp(-mortrisk_rate*lifeexp)

```

# after 5% improvement in adherence
supplemental table 3 from: https://doi.org/10.1177/2381468317725741

BP meds:
2^((-8.8*((-1.84775*(10^(-5)))*(57.88^2)+(1.5841*(10^(-3)))*57.88+(2.8672*(10^(-2))))))
 = 0.70

RR reduced by 0.70 for 5% more people

statins:
RR reduced by 30% [atorva20] for 5% more people

